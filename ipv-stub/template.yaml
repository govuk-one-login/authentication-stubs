AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31
  - AWS::LanguageExtensions
Description: IPV stub

#      Tags:
#        Service: IPV stubs
#        Source: govuk-one-login/authentication-stubs

Parameters:
  Environment:
    Type: String
    AllowedValues:
      - dev
      - build
      - staging
      - build

  SubEnvironment:
    Type: String
    Description: >
      When deploying to dev, optionally configure which sub-environment to deploy to
      i.e. authdev1, authdev2. This feature is not available for route-to-live environments
    Default: none
    AllowedValues:
      - none
      - authdev1
      - authdev2
      - authdev3

  CodeSigningConfigArn:
    Type: String
    Description: The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Default: none

  PermissionsBoundary:
    Type: String
    Description: The ARN of the permissions boundary to apply when creating IAM roles
    Default: none

Mappings:
  EnvironmentConfiguration:
    dev:
      ipvStubDomainName: ipvstub.signin.dev.account.gov.uk
      hostedZoneId: "Z07405851J4NJYGEP1PS7"
      ipvprivateencryptionkey: "{{resolve:secretsmanager:/dev/stubs/ipv-stub-private-key::::13d29a8d-453e-4786-a485-91eb59967ba8}}"
      ipvpublicencryptionkey: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApuWFONCQ572vESMrN0Wj
        +Q3J866fk0x0GF1TaLJDk7X7RdooUAQo95b1e1Qg+UFHR6P9+Ay1u7xdjmud4w/3
        zIHQzXejRwy/RruymdimvvJAKfh1nDsQUygssGoCFWcCaq7ywMHx/kKIy1GBh2vY
        wyOCs1IvK8C8hTEy7hvVQ4vEZu17o+EBgbwX5398DebXXB6SNCKqDZnmLYDfmhGd
        beQWJg5UIvT2fRNBoevG+N4kZKmjpyANmOKY/J/lYzoHguXhACTFkPzxCkbSaZC/
        eUfXfBO9PWUTtwaxXrp3pjO421dWvuXfIOrV1YVmUhIpH193j9Roe4C3CGh18urF
        sQIDAQAB
        -----END PUBLIC KEY-----
      authpublicsigningkeyevcs: "{{resolve:secretsmanager:/dev/stubs/auth-evcs-public-signing-key::::c891b2a3-08c4-4bc6-8c3a-4134b4d75eeb}}"
      authpublicsigningkeyipv: "{{resolve:secretsmanager:/dev/stubs/auth-reverification-public-signing-key::::5654ae99-de8f-4f54-a6a6-f8c13b7139f8}}"
      authIpvPublicSigningKeyJwksEndpoint: "https://auth.dev.account.gov.uk/.well-known/reverification-jwk.json"
      authStorageTokenSigningKeyJwksEndpoint: "https://auth.dev.account.gov.uk/.well-known/storage-token-jwk.json"

    authdev1:
      ipvStubDomainName: ipvstub.signin.authdev1.dev.account.gov.uk
      hostedZoneId: "Z01488663SVMGDFYGEX88"
      ipvprivateencryptionkey: "{{resolve:secretsmanager:/authdev1/stubs/ipv-stub-private-key::::ea3de3c0-a3bb-41f6-9df6-dbf73ee9f75f}}"
      ipvpublicencryptionkey: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArJ8oZkHs+ReeZcUsIeWm
        bwigustlHH8Qlsb/3SAK1wPb2muVRtQPZjF9TGnu8cof9pHdOo1blpvr8NNTKKTW
        D+gQRi9NzlPEVWS0Uo7PFNb0CJ4Vzd5Qgrc8GMc35lcgF3UBNFdcLErfr8Mi1/qO
        zld/NBsLCgG/lQ/s8uoNv9jBtwKko+vR1OPt4ziGL2+OfOU5W6U8gwGexcpNEANx
        95gokzduQTMQUAuOvM/rQMKYGjUqKbiQyB89Y9o3b6SDF32tEkNkyfJ4tiEYJmrq
        V3/gq1/DRbG7neNvo/klcojjdmBsrn7eIb310NDJhAvS3CPcWnrcYRFZMdkBNikY
        9QIDAQAB
        -----END PUBLIC KEY-----
      authpublicsigningkeyevcs: "{{resolve:secretsmanager:/authdev1/stubs/auth-evcs-public-signing-key::::d2a26d29-f879-49b7-a8d9-f3eea9948421}}"
      authpublicsigningkeyipv: "{{resolve:secretsmanager:/authdev1/stubs/auth-reverification-public-signing-key::::a0460ed9-9e30-4562-be70-f3b69d4cb35c}}"
      authIpvPublicSigningKeyJwksEndpoint: "https://auth.authdev1.dev.account.gov.uk/.well-known/reverification-jwk.json"
      authStorageTokenSigningKeyJwksEndpoint: "https://auth.authdev1.dev.account.gov.uk/.well-known/storage-token-jwk.json"

    authdev2:
      ipvStubDomainName: ipvstub.signin.authdev2.dev.account.gov.uk
      hostedZoneId: "Z0283478G72QVGV7VVBG"
      ipvprivateencryptionkey: "{{resolve:secretsmanager:/authdev2/stubs/ipv-stub-private-key::::78c42d33-23d3-4bc3-865a-1df55660a5bb}}"
      ipvpublicencryptionkey: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArOb0Y+6vaIfR7ThOVIKJ
        die8s6Db4wifjZW4vnw6x+SOJfSMZTfju9gpN9rgHPkYtkaH8P3cU34Ow1w6nG91
        OijyX+u1Q/gzt2lSisQOUSGiK6yB0GEcPuQwqt6QH3o11oX78l3uvdQn0cbV3pAY
        Oce8mkg/ruDHRYw7dR+9F+5oDQ8gk25qQzwyoE7rkTxW5UvPH8kmQ4ioc7O1IoFl
        MKzhijegD77BqVWK1YRVjwWLGGj/gJQXY6jvEuDVrkMB992Oi0rno+DpCIT0/uZd
        6xn7WDx0bLme/nKHVKnWCAbpZ7beIQUaZKn/nSrNUlYIpI6DhMzecJDpNS2JvH8V
        RwIDAQAB
        -----END PUBLIC KEY-----
      authpublicsigningkeyevcs: "{{resolve:secretsmanager:/authdev2/stubs/auth-evcs-public-signing-key::::a49b05c6-38f3-4a52-8423-d5d76791fc03}}"
      authpublicsigningkeyipv: "{{resolve:secretsmanager:/authdev2/stubs/auth-reverification-public-signing-key::::785a8715-d904-4951-9125-bfdb7edccc9f}}"
      authIpvPublicSigningKeyJwksEndpoint: "https://auth.authdev2.dev.account.gov.uk/.well-known/reverification-jwk.json"
      authStorageTokenSigningKeyJwksEndpoint: "https://auth.authdev2.dev.account.gov.uk/.well-known/storage-token-jwk.json"

    authdev3:
      ipvStubDomainName: ipvstub.signin.authdev3.dev.account.gov.uk
      hostedZoneId: "Z04928373OSDE66G6PJLG"
      ipvprivateencryptionkey: "{{resolve:secretsmanager:/authdev3/stubs/ipv-stub-private-key::::72268d49-ae13-444b-a772-a46ba18dfce8}}"
      ipvpublicencryptionkey: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyHvYnObfl9G7YwKuskmi
        wYjcns/8GlRzRm+wpr8akFD7zWUMe36FVdyRmhGw5gchsYlIvapSatO6FNq+9BPm
        QqQB2HZV9YaNgyeLaCGifdiQBcBCjrafgareWRkOJiulRYbylBQ5Hz7GYdmn+gvl
        VtV/9PzAWUGMp2Um9mMqnNT+PYVvlKkvlpzvrJc4Dp4d5w+cw+IM1C0b7bE9eQ1M
        2JOxRePMjv8Ss1g/bhxfcd2jpT+HQZ4YoHVeZwQuGxJiPPYbK+iuVzggKERTp5cJ
        AbddzK0dWqEjv0I4d22BgTdPr/1KWkPLCnQovfLoAF2DfAsjTnlX+HXvrGpEDjCH
        nQIDAQAB
        -----END PUBLIC KEY-----
      authpublicsigningkeyevcs: "{{resolve:secretsmanager:/authdev3/stubs/auth-evcs-public-signing-key::::7f35f880-0303-4530-bb15-3f10ed2ed045}}"
      authpublicsigningkeyipv: "{{resolve:secretsmanager:/authdev3/stubs/auth-reverification-public-signing-key::::60f8851d-617f-4a15-abd9-698c6fd3f8c9}}"
      authIpvPublicSigningKeyJwksEndpoint: "https://auth.authdev3.dev.account.gov.uk/.well-known/reverification-jwk.json"
      authStorageTokenSigningKeyJwksEndpoint: "https://auth.authdev3.dev.account.gov.uk/.well-known/storage-token-jwk.json"

    build:
      ipvStubDomainName: ipvstub.signin.build.account.gov.uk
      hostedZoneId: "Z09720813AWZDQSXZBWKJ"
      ipvprivateencryptionkey: "{{resolve:secretsmanager:/build/stubs/ipv-stub-private-key::::1c764b26-dbfe-488a-aacc-c33a33cdf7ee}}"
      ipvpublicencryptionkey: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAo9DGrlCJ1qrrXzeiSeLr
        6rzPmsIiF6hGxl8B4axJkBsfZWldFpPw1CvX/sP1FtY5fdVdUG7U1uMObcmE43tQ
        EiBv7vPWZ9wRI7knjc8ncrGmzhU1eeWyrhDIuhnJFm2iCldigLQu7DfCJMWAtsk2
        g/NMKsC9qYmyHD9QIpQTVt9/HjfzYXFTXtSettNlku2Xi5FjtCpdLEXOMezhRXjF
        imObuMzdLZYryP17mr2OJy9d+227FCexPG6UYOgH21RtOE9gxC2iLGMdqEmfTQt/
        G+lrdOD+OMl6qTVg+zJqG3amdPFnb4Vmnp8rOVnio30PFd71JxSqQsED8jjUW6KK
        FQIDAQAB
        -----END PUBLIC KEY-----
      authpublicsigningkeyevcs: "{{resolve:secretsmanager:/build/stubs/auth-evcs-public-signing-key::::3ef9f3d5-1599-4bc6-b2f8-4584496fc5b1}}"
      authpublicsigningkeyipv: "{{resolve:secretsmanager:/build/stubs/auth-reverification-public-signing-key::::d29ce375-b48b-4734-bb81-aa01d69c365b}}"
      authIpvPublicSigningKeyJwksEndpoint: "https://auth.build.account.gov.uk/.well-known/reverification-jwk.json"
      authStorageTokenSigningKeyJwksEndpoint: "https://auth.build.account.gov.uk/.well-known/storage-token-jwk.json"

Conditions:
  UseCodeSigning: !Not [!Equals [none, !Ref CodeSigningConfigArn]]
  UsePermissionsBoundary: !Not [!Equals [none, !Ref PermissionsBoundary]]
  UseSubEnvironment:
    Fn::And:
      - Fn::Equals:
          - !Ref Environment
          - dev
      - Fn::Not:
          - Fn::Equals:
              - !Ref SubEnvironment
              - none

Globals:
  Function:
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    CodeUri: .
    Runtime: nodejs20.x
    Architectures:
      - arm64

Resources:
  # API Gateway
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub ${AWS::StackName}-ApiGateway
      StageName: Live
      AlwaysDeploy: true
      EndpointConfiguration: REGIONAL
      DefinitionBody:
        openapi: "3.0.1"
        info:
          title: "Auth Team IPV Stub"
          version: "1.0"
        paths:
          /authorize:
            get:
              responses:
                "200":
                  description: OK
                  content:
                    application/json:
                      schema:
                        type: object
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IPVStubAuthorizeLambda.Arn}/invocations
                passThroughBehavior: "when_no_match"
                payloadFormatVersion: "2.0"
            post:
              responses:
                "200":
                  description: OK
                  content:
                    application/json:
                      schema:
                        type: object
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IPVStubAuthorizeLambda.Arn}/invocations
                passThroughBehavior: "when_no_match"
                payloadFormatVersion: "2.0"
          /token:
            post:
              responses:
                "200":
                  description: OK
                  content:
                    application/json:
                      schema:
                        type: object
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IPVStubTokenLambda.Arn}/invocations
                passThroughBehavior: "when_no_match"
                payloadFormatVersion: "2.0"
          /reverification:
            get:
              responses:
                "200":
                  description: OK
                  content:
                    application/json:
                      schema:
                        type: object
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IPVStubReverificationLambda.Arn}/invocations
                passThroughBehavior: "when_no_match"
                payloadFormatVersion: "2.0"
          /.well-known/jwks.json:
            get:
              responses:
                "200":
                  description: OK
                  content:
                    application/json:
                      schema:
                        type: object
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: "POST"
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IPVStubJwksLambda.Arn}/invocations
                passThroughBehavior: "when_no_match"
                payloadFormatVersion: "2.0"
        x-amazon-apigateway-policy:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Principal: "*"
              Action: "execute-api:Invoke"
              Resource: "*"

  ApiGatewayInvokePermissionForLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt IPVStubAuthorizeLambda.Arn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com

  ApiGatewayInvokePermissionForJwksLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt IPVStubJwksLambda.Arn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com

  ApiGatewayMapping:
    Type: AWS::ApiGateway::BasePathMapping
    DependsOn: Certificate
    Properties:
      Stage: Live
      DomainName: !Ref GatewayDomain
      RestApiId: !Ref ApiGateway

  # Authorize lambda
  IPVStubAuthorizeLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/ipv-authorize.handler
      Timeout: 30
      LoggingConfig:
        LogGroup: !Ref IPVStubAuthorizeLambdaLogGroup
      Environment:
        Variables:
          ENVIRONMENT: !If
            - UseSubEnvironment
            - !Ref SubEnvironment
            - !Ref Environment
          IPV_PRIVATE_ENCRYPTION_KEY: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - ipvprivateencryptionkey
          AUTH_PUBLIC_SIGNING_KEY_EVCS: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - authpublicsigningkeyevcs
          AUTH_PUBLIC_SIGNING_KEY_IPV: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - authpublicsigningkeyipv
          AUTH_IPV_PUBLIC_SIGNING_KEY_JWKS_ENDPOINT: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - authIpvPublicSigningKeyJwksEndpoint
          AUTH_IPV_STORAGE_TOKEN_SIGNING_KEY_JWKS_ENDPOINT: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - authStorageTokenSigningKeyJwksEndpoint
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ReverificationTable
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Sub
              - "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${env}/stubs/ipv-stub-private-key-*"
              - env:
                  !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      Events:
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /authorize
            Method: get
        Post:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /authorize
            Method: post
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/endpoints/ipv-authorize.ts
        External:
          - "@aws-sdk/client-dynamodb"
          - "@aws-sdk/lib-dynamodb"
        Minify: true
        Sourcemap: true
        Target: node20

  IPVStubAuthorizeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub
        - "/aws/lambda/${env}-ipv-stub-authorize"
        - env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      RetentionInDays: 30

  # Token lambda
  IPVStubTokenLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/ipv-token.handler
      LoggingConfig:
        LogGroup: !Ref IPVStubTokenLambdaLogGroup
      Environment:
        Variables:
          ENVIRONMENT: !If
            - UseSubEnvironment
            - !Ref SubEnvironment
            - !Ref Environment
          AUTH_PUBLIC_SIGNING_KEY_IPV: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - authpublicsigningkeyipv
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ReverificationTable
      Events:
        Post:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /token
            Method: post
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/endpoints/ipv-token.ts
        Minify: true
        Sourcemap: true
        Target: node20

  IPVStubTokenLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub
        - "/aws/lambda/${env}-ipv-stub-token"
        - env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      RetentionInDays: 30

  # Reverification lambda
  IPVStubReverificationLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/ipv-reverification.handler
      LoggingConfig:
        LogGroup: !Ref IPVStubReverificationLambdaLogGroup
      Environment:
        Variables:
          ENVIRONMENT: !If
            - UseSubEnvironment
            - !Ref SubEnvironment
            - !Ref Environment
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ReverificationTable
      Events:
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /reverification
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/endpoints/ipv-reverification.ts
        Minify: true
        Sourcemap: true
        Target: node20

  IPVStubReverificationLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub
        - "/aws/lambda/${env}-ipv-stub-reverification"
        - env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      RetentionInDays: 30

  # JWKS lambda
  IPVStubJwksLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/endpoints/jwks.handler
      LoggingConfig:
        LogGroup: !Ref IPVStubJwksLambdaLogGroup
      Environment:
        Variables:
          IPV_PUBLIC_ENCRYPTION_KEY: !FindInMap
            - EnvironmentConfiguration
            - !If
              - UseSubEnvironment
              - !Ref SubEnvironment
              - !Ref Environment
            - ipvpublicencryptionkey
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /.well-known/jwks.json
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/endpoints/jwks.ts
        External:
          - "@aws-sdk/client-kms"
        Minify: true
        Sourcemap: true
        Target: node20

  IPVStubJwksLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub
        - "/aws/lambda/${env}-ipv-stub-jwks"
        - env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      RetentionInDays: 30

  ReverificationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub
        - "${env}-AuthIpvStub-Reverification"
        - env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      KeySchema:
        - AttributeName: ReverificationId
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: ReverificationId
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Reverification

  # Domain config
  GatewayDomain:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: !FindInMap
        - EnvironmentConfiguration
        - !If
          - UseSubEnvironment
          - !Ref SubEnvironment
          - !Ref Environment
        - ipvStubDomainName
      SecurityPolicy: TLS_1_2
      RegionalCertificateArn: !Ref Certificate
      EndpointConfiguration:
        Types:
          - REGIONAL

  Certificate:
    Type: AWS::CertificateManager::Certificate
    DependsOn: ApiGatewayLiveStage
    Properties:
      DomainName: !FindInMap
        - EnvironmentConfiguration
        - !If
          - UseSubEnvironment
          - !Ref SubEnvironment
          - !Ref Environment
        - ipvStubDomainName
      ValidationMethod: DNS

  IPVdnsrecordsubdomain:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !FindInMap
        - EnvironmentConfiguration
        - !If
          - UseSubEnvironment
          - !Ref SubEnvironment
          - !Ref Environment
        - hostedZoneId
      Type: A
      Name: !FindInMap
        - EnvironmentConfiguration
        - !If
          - UseSubEnvironment
          - !Ref SubEnvironment
          - !Ref Environment
        - ipvStubDomainName
      AliasTarget:
        DNSName: !GetAtt GatewayDomain.RegionalDomainName
        HostedZoneId: !GetAtt GatewayDomain.RegionalHostedZoneId
